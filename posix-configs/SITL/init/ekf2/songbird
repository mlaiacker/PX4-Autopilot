uorb start
param load
dataman start

tone_alarm start

param set  SYS_HITL		1

param set BAT_N_CELLS 	8
param set BAT_A_PER_V	1.0
param set BAT_CAPACITY		10000.0
param set BAT_CNT_V_CURR		8.0566405E-4
param set BAT_CNT_V_VOLT		8.0566405E-4
param set BAT_CRIT_THR		0.07
param set BAT_EMERGEN_THR		0.05
param set BAT_LOW_THR		0.15
param set BAT_R_INTERNAL	1	-1.0
param set BAT_SOURCE		1
param set BAT_V_CHARGED		4.05
param set BAT_V_DIV		15.468
param set BAT_V_EMPTY		3.25
param set BAT_V_LOAD_DROP		0.3
param set BAT_V_OFFS_CURR		0.0

param set CAL_ACC0_EN		1
param set CAL_ACC0_ID		2
param set CAL_ACC0_XOFF		0
param set CAL_ACC0_XSCALE		1
param set CAL_ACC0_YOFF		0
param set CAL_ACC0_YSCALE		1
param set CAL_ACC0_ZOFF		0
param set CAL_ACC0_ZSCALE		1

param set CAL_GYRO0_EN		1
param set CAL_GYRO0_ID		2
param set CAL_GYRO0_XOFF		0
param set CAL_GYRO0_XSCALE	1.0
param set CAL_GYRO0_YOFF		0
param set CAL_GYRO0_YSCALE	1.0
param set CAL_GYRO0_ZOFF		0
param set CAL_GYRO0_ZSCALE	1.0

param set CAL_MAG0_EN		1
param set CAL_MAG0_ID		2
param set CAL_MAG0_ROT	-1
param set CAL_MAG0_XOFF		0
param set CAL_MAG0_XSCALE		1
param set CAL_MAG0_YOFF		0
param set CAL_MAG0_YSCALE		1
param set CAL_MAG0_ZOFF		0
param set CAL_MAG0_ZSCALE		1

param set COM_DISARM_LAND 5
param set COM_RC_IN_MODE 1

param set EKF2_AID_MASK 1
param set EKF2_ANGERR_INIT 0.01
param set EKF2_GBIAS_INIT 0.01
param set EKF2_HGT_MODE 0
param set EKF2_MAG_TYPE 1

param set FW_AIRSPD_MAX 30
param set FW_AIRSPD_MIN 16
param set FW_AIRSPD_TRIM 18

set MIXER SBV3
set PWM_OUT 1234
set PWM_RATE 400

set MIXER_AUX SBV3
set PWM_ACHDIS 5
set PWM_AUX_DISARMED 950

param set MAV_TYPE 22
replay tryapplyparams

param set SYS_AUTOSTART 13015

if param compare SYS_AUTOSTART 0
then
	param set CBRK_AIRSPD_CHK	162128
	param set CBRK_BUZZER		0
	param set CBRK_ENGINEFAIL	284953
	param set CBRK_FLIGHTTERM	121212
	param set CBRK_GPSFAIL		0
	param set CBRK_IO_SAFETY	22027
	param set CBRK_RATE_CTRL	0
	param set CBRK_SUPPLY_CHK	0
	param set CBRK_USB_CHK		0
	param set CBRK_VELPOSERR	0
	
	param set MC_PITCH_P 6
	param set MC_PITCHRATE_P 0.2
	param set MC_ROLL_P 6
	param set MC_ROLLRATE_P 0.3
	
	param set MIS_LTRMIN_ALT 10
	param set MIS_TAKEOFF_ALT 10
	param set MIS_YAW_TMT 10
	
	param set MPC_ACC_HOR_MAX 2
	param set MPC_ACC_HOR_MAX 2.0
	param set MPC_TKO_SPEED 1.0
	param set MPC_XY_P 1.0
	param set MPC_XY_VEL_D 0.01
	param set MPC_XY_VEL_I 0.02
	param set MPC_XY_VEL_P 0.09
	param set MPC_Z_VEL_I 0.02
	param set MPC_Z_VEL_MAX_DN 0.5
	param set MPC_Z_VEL_P 0.2
	
	param set NAV_ACC_RAD 5.0
	param set NAV_DLL_ACT 2
	param set NAV_LOITER_RAD 80
	
	param set RTL_DESCEND_ALT 45.0
	param set RTL_LAND_DELAY 0
	param set RTL_RETURN_ALT 100.0
	
	param set SDLOG_DIRS_MAX 7
	
	param set SENS_BOARD_ROT 0
	param set SENS_BOARD_X_OFF 0.000001
	param set SENS_DPRES_OFF 0.001
	
	param set SYS_AUTOSTART 13015
	param set SYS_MC_EST_GROUP 2
	#param set SYS_RESTART_TYPE 2
	
	param set VT_ARSP_BLEND		8.0
	param set VT_ARSP_TRANS		14.0
	param set VT_B_DEC_MSS		1.0
	param set VT_B_REV_DEL		0.0
	param set VT_B_TRANS_DUR	4.0
	param set VT_B_TRANS_THR	1.0
	param set VT_ELEV_MC_LOCK	1
	param set VT_FW_ALT_ERR		0.0
	param set VT_FW_DIFTHR_EN	0
	param set VT_FW_DIFTHR_SC	0.1
	param set VT_FW_MIN_ALT		0.0
	param set VT_FW_MOT_OFFID	0
	param set VT_FW_PERM_STAB	0
	param set VT_FW_QC_P		0
	param set VT_FW_QC_R		0
	param set VT_F_TRANS_DUR	4.0
	param set VT_F_TRANS_THR	0.85
	param set VT_F_TR_OL_TM		6.0
	param set VT_IDLE_PWM_MC	1070
	param set VT_MOT_COUNT		4
	param set VT_TILT_FW		1.0
	param set VT_TILT_MC		0.0
	param set VT_TILT_TRANS		0.35
	param set VT_TRANS_MIN_TM	3.0
	param set VT_TRANS_P2_DUR	1.0
	param set VT_TRANS_TIMEOUT	15.0
	param set VT_TYPE			1
	param set VT_WV_LND_EN		1
	param set VT_WV_LTR_EN		1
	param set VT_WV_TKO_EN		1
	param set VT_WV_YAWR_SCL	2.0
fi

replay tryapplyparams


pwm_out_sim start

set OUTPUT_MODE hil

mixer load /dev/pwm_output0 ROMFS/sitl/mixers/songbird.mix

sensors start -h
commander start --hil

land_detector start vtol
navigator start
ekf2 start
vtol_att_control start
mc_pos_control start
mc_att_control start
fw_pos_control_l1 start
fw_att_control start
wind_estimator start

mavlink start -x -u 14556 -r 2000000 -f
mavlink start -x -u 14557 -r 2000000 -m onboard -o 14540 -f
mavlink stream -r 20 -s EXTENDED_SYS_STATE -u 14557

mavlink stream -r 80 -s POSITION_TARGET_LOCAL_NED -u 14556
mavlink stream -r 80 -s LOCAL_POSITION_NED -u 14556
mavlink stream -r 80 -s GLOBAL_POSITION_INT -u 14556
mavlink stream -r 80 -s ATTITUDE -u 14556
mavlink stream -r 80 -s ATTITUDE_QUATERNION -u 14556
mavlink stream -r 80 -s ATTITUDE_TARGET -u 14556
mavlink stream -r 20 -s RC_CHANNELS -u 14556
#mavlink stream -r 250 -s HIGHRES_IMU -u 14556
#mavlink stream -r 10 -s OPTICAL_FLOW_RAD -u 14556
mavlink stream -r 10 -s HIL_ACTUATOR_CONTROLS -u 14556
mavlink stream -r 100 -s HIL_ACTUATOR_CONTROLS -u 14557

logger start -e -t
#replay trystart
mavlink stream -r 200 -s HIL_ACTUATOR_CONTROLS -u 14557

linux_sbus start -d /dev/ttyUSB0

gd_payload start

mavlink boot_complete
